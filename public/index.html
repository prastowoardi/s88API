<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Payment API</title>
<style>
  body {
    font-family: monospace;
    background: #121212;
    color: #0f0;
    margin: 0; padding: 20px;
  }
  #terminal {
    background: #1e1e1e;
    height: 350px;
    overflow-y: auto;
    white-space: pre-wrap;
    padding: 10px;
    outline: none;
    border-radius: 5px;
  }
  /* Kursor berkedip */
  .cursor {
    display: inline-block;
    width: 10px;
    background: #0f0;
    animation: blink 1s steps(2, start) infinite;
  }
  @keyframes blink {
    to {
      visibility: hidden;
    }
  }
</style>
</head>
<body>

<h2>Select Action</h2>
<select id="scriptSelect">
    <option value="pbov2:stag">Staging - PayBO - Deposit V2</option>
    <option value="pbodp:stag">Staging - PayBO - Deposit V3</option>
    <option value="pbov4:stag">Staging - PayBO - Deposit V4</option>
    <option value="pbowd:stag">Staging - PayBO - Payout</option>
    <option value="#">=================</option>
    <option value="v2:stag">Staging - S88 - Deposit V2</option>
    <option value="deposit:stag">Staging - S88 - Deposit V3</option>
    <option value="payout:stag">Staging - S88 - Payout</option>
    <option value="#">=================</option>
    <option value="pbov2:prod">Production - PayBO - Deposit V2</option>
    <option value="pbodp:prod">Production - PayBO - Deposit V3</option>
    <option value="pbov4:prod">Production - PayBO - Deposit V4</option>
    <option value="#">=================</option>
    <option value="v2:prod">Production - S88 - Deposit V2</option>
    <option value="deposit:prod">Production - S88 - Deposit V3</option>
</select>
<button id="runBtn">Running</button>

<div id="terminal" contenteditable="true" spellcheck="false"></div>

<script>
    const terminal = document.getElementById('terminal');
    const runBtn = document.getElementById('runBtn');
    const scriptSelect = document.getElementById('scriptSelect');

    let ws;
    let isRunning = false;
    let inputBuffer = '';
    let promptActive = false;

    function addCursor() {
        const cursorSpan = document.createElement('span');
        cursorSpan.classList.add('cursor');
        return cursorSpan;
    }

    function focusTerminal() {
        terminal.focus();
        placeCaretAtEnd(terminal);
        terminal.scrollTop = terminal.scrollHeight;
    }

    function placeCaretAtEnd(el) {
        el.focus();
        if (typeof window.getSelection != "undefined"
        && typeof document.createRange != "undefined") {
        const range = document.createRange();
        range.selectNodeContents(el);
        range.collapse(false);
        const sel = window.getSelection();
        sel.removeAllRanges();
        sel.addRange(range);
        }
    }

    function initWebSocket() {
        ws = new WebSocket(`ws://${location.hostname}:8080`);

        ws.onopen = () => {
        appendOutput('\n✅ WebSocket connected\n');
        isRunning = false;
        promptActive = false;
        };

        ws.onerror = err => {
        appendOutput('\n❌ WebSocket error\n');
        console.error('WebSocket error', err);
        };

        ws.onclose = () => {
        appendOutput('\n⚠️ WebSocket connection closed\n');
        isRunning = false;
        promptActive = false;
        };

        ws.onmessage = event => {
        const msg = JSON.parse(event.data);
        if (msg.type === 'stdout' || msg.type === 'stderr') {
            appendOutput(msg.data);
        } else if (msg.type === 'close') {
            appendOutput(`\n✅ Selesai (exit code ${msg.code})\n`);
            isRunning = false;
            promptActive = false;
        } else if (msg.type === 'error') {
            appendOutput(`\n❌ ERROR: ${msg.data}\n`);
            isRunning = false;
            promptActive = false;
        }
        focusTerminal();
        };
    }

    function appendOutput(text) {
        removeCursor();
        
        terminal.textContent += text;

        terminal.appendChild(addCursor());

        focusTerminal();
    }

    function removeCursor() {
        const cursor = terminal.querySelector('.cursor');
        if (cursor) {
        cursor.remove();
        }
    }

    runBtn.onclick = () => {
        if (isRunning) {
            alert('Script sedang berjalan. Tunggu sampai selesai.');
            return;
        }
        if (ws.readyState !== WebSocket.OPEN) {
            alert('WebSocket belum tersambung.');
            return;
        }

        terminal.textContent = '';
        appendOutput(`▶️ Menjalankan: ${scriptSelect.options[scriptSelect.selectedIndex].text}\n`);

        ws.send(JSON.stringify({ type: 'run-script', script: scriptSelect.value }));
        isRunning = true;
        promptActive = true;
        inputBuffer = '';
        focusTerminal();
    };

    terminal.addEventListener('keydown', e => {
        if (e.ctrlKey || e.metaKey) {
            return;
        }

        if (!isRunning || !promptActive) {
            e.preventDefault();
            return;
        }

        if (e.key === 'Backspace') {
            e.preventDefault();
            if (inputBuffer.length > 0) {
            inputBuffer = inputBuffer.slice(0, -1);
            updateInputLine();
            }
        } else if (e.key === 'Enter') {
            e.preventDefault();
            ws.send(JSON.stringify({ type: 'stdin', data: inputBuffer + '\n' }));
            // appendOutput(inputBuffer + '\n');
            inputBuffer = '';
            updateInputLine();
        } else if (e.key.length === 1) {
            e.preventDefault();
            inputBuffer += e.key;
            updateInputLine();
        }
    });

    function updateInputLine() {
        removeCursor();
        const content = terminal.textContent;
        const lastNewline = content.lastIndexOf('\n');
        const before = lastNewline >= 0 ? content.slice(0, lastNewline + 1) : '';
        terminal.textContent = before;
        terminal.append(document.createTextNode(inputBuffer));
        terminal.appendChild(addCursor());
        focusTerminal();
    }


    window.addEventListener('load', () => {
        initWebSocket();
        terminal.focus();
    });
</script>

</body>
</html>
